#---1-----ä»kaggleå¹³å°ä¸‹è½½å¤„ç†å¥½çš„ç•ªèŒ„æ•°æ®é›†
import kagglehub
path = kagglehub.dataset_download("tomgzg/split-tomato-data-4")
print("Path to dataset files:", path)
'''
Path to dataset files:å°†ä¼šè¾“å‡ºä¸‹è½½åä¿å­˜çš„æ•°æ®è·¯å¾„
'''

#æŸ¥çœ‹åˆ’åˆ†å¥½çš„æ•°æ®é›†è·¯å¾„
import os
base_path = "/root/.cache/kagglehub/datasets/tomgzg/split-tomato-data-4/versions/1"
print("ç›®å½•å†…å®¹:", os.listdir(base_path))
'''
å°†ä¸Šä¸€æ­¥è¾“å‡ºçš„æ•°æ®è·¯å¾„å¤åˆ¶ç»™base_pathå˜é‡
'''

#æ£€æŸ¥trainã€valã€testçš„å›¾åƒæ•°æ®ä¿¡æ¯
import os
# æŸ¥çœ‹æ¯ä¸ªåˆ’åˆ†æ•°æ®çš„æ•°é‡
for split in ['train', 'val', 'test']:
    output_dir = '/root/.cache/kagglehub/datasets/tomgzg/split-tomato-data-4-224x224/versions/1'
    split_path = os.path.join(output_dir, split)
    for class_name in os.listdir(split_path):
        class_path = os.path.join(split_path, class_name)
        print(f"{split} - {class_name}: {len(os.listdir(class_path))} å¼ å›¾åƒ")

#-----2------ä½¿ç”¨å“ˆå¸Œå€¼æŠ€æœ¯æ£€æŸ¥åˆ’åˆ†å¥½çš„æ•°æ®é›†ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®æ³„éœ²
import os
import hashlib

# è®¡ç®—å›¾ç‰‡çš„å“ˆå¸Œå€¼
def get_image_hash(image_path):
    with open(image_path, "rb") as f:
        return hashlib.md5(f.read()).hexdigest()

# æ£€æŸ¥æ•°æ®æ³„æ¼
def check_duplicates(split1, split2):
    output_dir = '/root/.cache/kagglehub/datasets/tomgzg/split-tomato-data-4-224x224/versions/1'
    split1_path = os.path.join(output_dir, split1)
    split2_path = os.path.join(output_dir, split2)
    split1_hashes = {}
    split2_hashes = {}

    # è®¡ç®—ç¬¬ä¸€ä¸ªåˆ’åˆ†çš„å“ˆå¸Œå€¼
    for class_name in os.listdir(split1_path):
        class_path = os.path.join(split1_path, class_name)
        for img_name in os.listdir(class_path):
            img_path = os.path.join(class_path, img_name)
            split1_hashes[get_image_hash(img_path)] = img_path

    # è®¡ç®—ç¬¬äºŒä¸ªåˆ’åˆ†çš„å“ˆå¸Œå€¼å¹¶æ£€æŸ¥é‡å¤
    duplicates = []
    for class_name in os.listdir(split2_path):
        class_path = os.path.join(split2_path, class_name)
        for img_name in os.listdir(class_path):
            img_path = os.path.join(class_path, img_name)
            img_hash = get_image_hash(img_path)
            if img_hash in split1_hashes:
                duplicates.append((split1_hashes[img_hash], img_path))

    return duplicates

# æ£€æŸ¥è®­ç»ƒé›†å’Œæµ‹è¯•é›†æ˜¯å¦æœ‰é‡å¤å›¾ç‰‡
duplicates = check_duplicates('train', 'test')
if duplicates:
    print("å‘ç°é‡å¤å›¾ç‰‡:")
    for dup in duplicates:
        print(f"è®­ç»ƒé›†: {dup[0]} <=> æµ‹è¯•é›†: {dup[1]}")
else:
    print("è®­ç»ƒé›†å’Œæµ‹è¯•é›†æ²¡æœ‰é‡å¤å›¾ç‰‡ã€‚")

# æ£€æŸ¥è®­ç»ƒé›†å’ŒéªŒè¯é›†æ˜¯å¦æœ‰é‡å¤å›¾ç‰‡
duplicates = check_duplicates('train', 'val')
if duplicates:
    print("å‘ç°é‡å¤å›¾ç‰‡:")
    for dup in duplicates:
        print(f"è®­ç»ƒé›†: {dup[0]} <=> éªŒè¯é›†: {dup[1]}")
else:
    print("è®­ç»ƒé›†å’ŒéªŒè¯é›†æ²¡æœ‰é‡å¤å›¾ç‰‡ã€‚")

#------3------æ”¹å˜å›¾åƒåˆ†è¾¨ç‡ä»254åˆ°224
import os
from PIL import Image
from tqdm import tqdm  # è¿›åº¦æ¡æ”¯æŒ

def center_crop_images(input_root, output_root, target_size=(224, 224)):
    """
    å°†ç›®å½•ä¸­çš„æ‰€æœ‰å›¾åƒä¸­å¿ƒè£å‰ªåˆ°æŒ‡å®šå°ºå¯¸
    :param input_root: åŸå§‹æ•°æ®æ ¹ç›®å½•
    :param output_root: è¾“å‡ºæ•°æ®æ ¹ç›®å½•
    :param target_size: ç›®æ ‡å°ºå¯¸ (å®½, é«˜)
    """
    # åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
    os.makedirs(output_root, exist_ok=True)
    
    for split in ['train', 'val', 'test']:
        split_input = os.path.join(input_root, split)
        split_output = os.path.join(output_root, split)
        os.makedirs(split_output, exist_ok=True)
        
        for class_name in tqdm(os.listdir(split_input), desc=f"Processing {split}"):
            class_input = os.path.join(split_input, class_name)
            class_output = os.path.join(split_output, class_name)
            os.makedirs(class_output, exist_ok=True)
            
            for img_name in os.listdir(class_input):
                if img_name.lower().endswith(('.png', '.jpg', '.jpeg')):
                    input_path = os.path.join(class_input, img_name)
                    output_path = os.path.join(class_output, img_name)
                    
                    try:
                        # æ‰“å¼€å›¾åƒå¹¶ä¸­å¿ƒè£å‰ª
                        with Image.open(input_path) as img:
                            width, height = img.size
                            left = (width - target_size[0]) // 2
                            top = (height - target_size[1]) // 2
                            right = left + target_size[0]
                            bottom = top + target_size[1]
                            
                            cropped_img = img.crop((left, top, right, bottom))
                            cropped_img.save(output_path)
                    except Exception as e:
                        print(f"Error processing {input_path}: {str(e)}")

# é…ç½®è·¯å¾„
input_root = "/root/.cache/kagglehub/datasets/tomgzg/split-tomato-data-4/versions/1"
output_root = "/root/.cache/kagglehub/datasets/tomgzg/split-tomato-data-4-224x224/versions/1"

# æ‰§è¡Œè£å‰ª
center_crop_images(input_root, output_root, target_size=(224, 224))

#------4----------æŸ¥çœ‹æ˜¯å¦å°†æ‰€æœ‰å›¾åƒæ•°æ®åˆ†è¾¨ç‡è°ƒæ•´ä¸º224
import os
from PIL import Image
from collections import defaultdict

def check_resolutions(data_root):
    splits = ['train', 'val', 'test']
    resolution_stats = {}
    
    for split in splits:
        split_path = os.path.join(data_root, split)
        resolutions = defaultdict(int)
        
        for class_name in os.listdir(split_path):
            class_path = os.path.join(split_path, class_name)
            
            for img_name in os.listdir(class_path):
                if img_name.lower().endswith(('.png', '.jpg', '.jpeg')):
                    img_path = os.path.join(class_path, img_name)
                    try:
                        with Image.open(img_path) as img:
                            w, h = img.size
                            resolutions[(w, h)] += 1
                    except Exception as e:
                        print(f"Error processing {img_path}: {str(e)}")
        
        resolution_stats[split] = resolutions
    
    return resolution_stats

# æ•°æ®é›†è·¯å¾„
data_root = "/root/.cache/kagglehub/datasets/tomgzg/split-tomato-data-4-224x224/versions/1"
stats = check_resolutions(data_root)

# æ‰“å°ç»“æœ
for split, resolutions in stats.items():
    print(f"\nğŸ” {split.capitalize()} é›†åˆ†è¾¨ç‡ç»Ÿè®¡:")
    total_images = sum(resolutions.values())
    print(f"  æ€»å›¾åƒæ•°: {total_images}")
    
    for (w, h), count in resolutions.items():
        percentage = (count / total_images) * 100
        print(f"  {w}Ã—{h}: {count} å¼  ({percentage:.2f}%)")
    
    # æ£€æŸ¥æ˜¯å¦ç»Ÿä¸€
    if len(resolutions) == 1:
        print("âœ… æ‰€æœ‰å›¾åƒåˆ†è¾¨ç‡ä¸€è‡´")
    else:
        print("âš ï¸ å­˜åœ¨å¤šç§åˆ†è¾¨ç‡")
